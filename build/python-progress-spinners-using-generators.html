<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="description" content="Josh Duncan – Designer. Maker. Fun haver." />
  <title>Josh Duncan – Blog</title>

  <link rel="stylesheet" type="text/css" href="/static/styles/styles.css" />
  <link rel="shortcut icon" href="/static/favicon.ico" />

  <!-- OPEN GRAPH, FACEBOOK, TWITTER META TAGS -->
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="joshbduncan.com" />
  <meta property="og:url" content="https://joshbduncan.com/python-progress-spinners-using-generators.html" />
  <meta property="og:image" content="https://joshbduncan.com/static/images/jbd-card.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Josh Duncan – Designer. Maker. Fun haver." />
  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Progress Spinners Using Python Generators and Context Managers" />
  <meta property="og:description" content="Making neat little progress spinners that let you know things are working in your cli apps is quite simple using Python generators and context manager." />
  <meta property="og:article:published_time" content="2022-04-01" />
  <meta property="og:article:author" content="Josh Duncan" />
  
  <meta property="og:article:section" content="development" />
  
  
  <meta property="og:article:tag" content="cli" />
  
  <meta property="og:article:tag" content="generators" />
  
  <meta property="og:article:tag" content="python" />
  
  
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@joshbduncan" />
  <meta name="twitter:creator" content="@joshbduncan" />

  <script data-goatcounter="https://jbd.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>

  <script>
    // color theme selector
    (function (window, document) {
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const selectedTheme = window.localStorage.getItem("theme");
      if (selectedTheme === "dark" || (!selectedTheme && prefersDark)) {
        document.documentElement.setAttribute("data-theme", "dark")
      };
      document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.querySelector(".toggle-theme");
        toggleButton.addEventListener("click", () => {
          const currentTheme = document.documentElement.getAttribute("data-theme");
          const theme = currentTheme == "dark" ? "light" : "dark";
          window.localStorage.setItem("theme", theme);
          document.documentElement.setAttribute("data-theme", theme)
          console.log("color theme switched to " + theme + ".");
        });
      });
    })(window, document);
  </script>
</head>

<body>
  <header id="page-header">
    <div id="logo">
      <a href="/" title="Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="75" height="75" fill="none" stroke="currentColor" stroke-width="4.5" viewBox="0 0 75 75">
          <path stroke-linecap="round" d="M22.9,71l-1.6-1.6c-6.5-6.4-10.1-15.2-10.1-24.3l0,0c0-4,1.6-7.8,4.4-10.7l0,0c2.8-2.8,6.6-4.3,10.6-4.3h5.5   c3.2,0,5.8,2.6,5.9,5.8l0,0c0,3.2-2.6,5.8-5.9,5.8h0h-8.8"></path>
          <path stroke-linecap="round" d="M22.9,41.8l1.1,0.4c8.2,3.3,13.5,11.2,13.6,20l0,0"></path>
          <path stroke-linecap="round" d="M53.7,69.4c6.5-6.4,10.1-15.2,10.1-24.3"></path>
          <path stroke-linecap="butt" d="M18.9,30.2l-3.6-19.3c-0.5-3.2,1.6-6.2,4.7-6.8c0.3,0,0.7,0,1,0c2.8,0,5.2,2,5.8,4.8l3.8,21.6"></path>
          <path stroke-linecap="butt" d="M32.5,31.5l4-22.6C36.9,6.1,39.4,4,42.2,4c0.3,0,0.7,0,1,0c3.2,0.6,5.3,3.6,4.7,6.8l-3.5,19.6"></path>
          <path stroke-linecap="round" d="M46.3,30.2L46.3,30.2c3.2,0,5.9,2.6,5.9,5.8v8.7c0,3.2-2.6,5.8-5.9,5.8h0c-3.2,0-5.9-2.6-5.9-5.8V36   C40.4,32.8,43,30.2,46.3,30.2z"></path>
          <path stroke-linecap="round" d="M58,33.1L58,33.1c3.2,0,5.9,2.6,5.9,5.8v5.8c0,3.2-2.6,5.8-5.9,5.8h0c-3.2,0-5.9-2.6-5.9-5.8v-5.8   C52.1,35.7,54.7,33.1,58,33.1z"></path>
        </svg>
      </a>
    </div id="logo">
    <div class="theme-toggle">
      <button title="Switch Color Theme" aria-label="Switch Color Theme" class="toggle-theme">
        <svg xmlns="http://www.w3.org/2000/svg" class="moon" fill="currentColor" width="1.5em" height="1.5em" viewBox="0 0 16 16">
          <path d="M8.832,4.669c.031-.093,.131-.143,.224-.113,.053,.018,.095,.059,.113,.113l.316,.95c.141,.423,.473,.755,.897,.897l.95,.316c.093,.031,.143,.131,.113,.224-.018,.053-.059,.095-.113,.113l-.95,.316c-.423,.141-.755,.473-.897,.897l-.316,.95c-.031,.093-.131,.143-.224,.113-.053-.018-.095-.059-.113-.113l-.316-.95c-.141-.423-.473-.755-.897-.897l-.95-.316c-.093-.031-.143-.131-.113-.224,.018-.053,.059-.095,.113-.113l.95-.316c.423-.141,.755-.473,.897-.897,0,0,.316-.95,.316-.95Z" />
          <path d="M11.888,2.446c.021-.062,.089-.095,.151-.073,.034,.012,.061,.039,.073,.073l.211,.633c.094,.283,.315,.504,.598,.598l.633,.211c.062,.021,.095,.089,.073,.151-.012,.034-.039,.061-.073,.073l-.633,.211c-.283,.094-.504,.316-.598,.598l-.211,.633c-.021,.062-.089,.095-.151,.073-.034-.012-.061-.039-.073-.073l-.211-.633c-.094-.283-.316-.504-.598-.598l-.633-.211c-.062-.021-.095-.089-.073-.151,.012-.034,.039-.061,.073-.073l.633-.211c.283-.094,.504-.315,.598-.598l.211-.632h0Z" />
          <path d="M8,14c-3.309,0-6-2.691-6-6,0-2.127,1.147-4.115,2.994-5.188,.196-.113,.444-.082,.604,.079,.161,.161,.193,.409,.079,.605-.443,.762-.677,1.628-.677,2.503,0,2.757,2.243,5,5,5,.875,0,1.74-.234,2.504-.678,.194-.113,.443-.082,.604,.079,.16,.16,.192,.408,.079,.604-1.072,1.847-3.061,2.994-5.188,2.994ZM4.108,4.87c-.705,.876-1.108,1.979-1.108,3.13,0,2.757,2.243,5,5,5,1.151,0,2.254-.403,3.13-1.108-.371,.071-.75,.108-1.13,.108-3.309,0-6-2.691-6-6,0-.38,.037-.758,.108-1.13Z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="sun" fill="currentColor" width="1.5em" height="1.5em" viewBox="0 0 16 16">
          <path d="M8,12c-2.206,0-4-1.794-4-4s1.794-4,4-4,4,1.794,4,4-1.794,4-4,4Zm0-7c-1.654,0-3,1.346-3,3s1.346,3,3,3,3-1.346,3-3-1.346-3-3-3Z" />
          <path d="M8.5,2.5c0,.276-.224,.5-.5,.5s-.5-.224-.5-.5V.5c0-.276,.224-.5,.5-.5s.5,.224,.5,.5V2.5Z" />
          <path d="M4.465,4.464c-.195,.195-.512,.195-.707,0l-1.415-1.414c-.094-.094-.146-.221-.147-.354s.053-.26,.146-.354c.195-.195,.512-.195,.707,0l1.415,1.414c.094,.094,.146,.221,.147,.354s-.053,.26-.146,.354Z" />
          <path d="M3,8c0,.276-.224,.5-.5,.5H.5C.224,8.5,0,8.276,0,8s.224-.5,.5-.5H2.5c.276,0,.5,.224,.5,.5Z" />
          <path d="M3.05,13.657c-.195,.195-.512,.195-.707,0s-.195-.512,0-.707l1.415-1.415c.195-.195,.512-.195,.707,0s.195,.512,0,.707l-1.415,1.415Z" />
          <path d="M8.5,15.5c0,.276-.224,.5-.5,.5s-.5-.224-.5-.5v-2c0-.276,.224-.5,.5-.5s.5,.224,.5,.5v2Z" />
          <path d="M13.657,13.657c-.195,.195-.512,.195-.707,0l-1.415-1.415c-.195-.195-.195-.512,0-.707s.512-.195,.707,0l1.415,1.415c.195,.195,.195,.512,0,.707Z" />
          <path d="M16,8c0,.276-.224,.5-.5,.5h-2c-.276,0-.5-.224-.5-.5s.224-.5,.5-.5h2c.276,0,.5,.224,.5,.5Z" />
          <path d="M12.242,4.465c-.195,.195-.512,.195-.707,0-.094-.094-.146-.221-.146-.354s.053-.26,.147-.354l1.415-1.414c.195-.195,.512-.195,.707,0,.094,.094,.146,.221,.146,.354s-.053,.26-.147,.354l-1.415,1.414Z" />
        </svg>
      </button>
    </div>
    <input id="toggle-nav" type="checkbox" autocomplete="off" />
    <label for="toggle-nav" id="hamburger">
      <svg id="icon-hamburger" xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
      </svg>
    </label>

    

    <nav>
      <ul role="menu">
        
        <li role="presentation"><a
             role="menuitem"
             href="/"
             >Home</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/about.html"
             >About</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/software.html"
             >Software</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/playground/"
             >Playground</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/categories.html"
             >Categories</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/tags.html"
             >Tags</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/search.html"
             >Search</a></li>
        
        <li role="presentation"><a
             role="menuitem"
             href="/rss.xml"
             >RSS</a></li>
        
      </ul>
    </nav>
  </header>

  <main>
    <!-- FLASK BLOCK CONTENT -->
    
<article>
  <header>
    <h1 id="post-title">Progress Spinners Using Python Generators and Context Managers</h1>
    <div id="post-meta">
      
      <b>Published</b> <time datetime="2022-04-01">April 2022</time>
      
      • 6 min read
    </div>
  </header>
  <section>
    <div id="post-body">
      <p>Often with long running scripts, it's nice to know that everything is working as it should. Now, I could easily just print to stdout...</p>
<div class="codehilite"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
<span class="gp">... </span>   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="gp">... </span>   <span class="n">long_running_process</span><span class="p">()</span>
<span class="go">processing step 1 of 300 steps</span>
<span class="go">processing step 2 of 300 steps</span>
<span class="go">...</span>
<span class="go">processing step 300 of 300 steps</span>
</code></pre></div>

<p>But that mucks up my terminal and causes a lot of scrolling.</p>
<p>So, below are three ways I've found to do this, from simple to over engineered... They all write to <a href="https://docs.python.org/3/library/sys.html#sys.stdout">stdout</a> using the <code>\r</code> carriage return so that they keep updating the same line and keep my terminal clean.</p>
<h2>Quick and Simple</h2>
<p>My first attempt at this utilized a basic generator that yields defined "ticks" which simulate a spinning line.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">spinner</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;working...&quot;</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tick</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)]</span>
        <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<p>And I would setup and invoke the generator like below.</p>
<div class="codehilite"><pre><span></span><code><span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample job&quot;</span><span class="p">,</span> <span class="s2">&quot;another job&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">spinner</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_running_iteration</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p><img alt="Simple Python Spinner" loading="lazy" src="/static/images/spinner-simple-1.gif" /></p>
<p>This works, but I see two problems. First, the second job overwrites the first job, and once a job is done, the spinner just ends at the last yielded "tick" which isn't a good look.</p>
<h3>Exiting The Generator</h3>
<p>To fix both issues, I'm going to catch the <a href="https://docs.python.org/3/library/exceptions.html#GeneratorExit">GeneratorExit</a> exception, then place a "✔" before the completed job and jump down a line so that any following output doesn't overwrite the previous output.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">spinner</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;working...&quot;</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">tick</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)]</span>
            <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">✔</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>

<p><img alt="Simple Python Spinner" loading="lazy" src="/static/images/spinner-simple-2.gif" /></p>
<h3>Catching Errors</h3>
<p>But what happens when there is an exception?</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>python<span class="w"> </span>spinner_simple.py
<span class="go">✔ processing sample job...</span>
<span class="go">✔ processing another job...</span>
<span class="go">✔ processing job with an exception...</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;/Users/jbd/Dropbox/DEV/projects/progress-spinner/spinner_simple.py&quot;, line 31, in &lt;module&gt;</span>
<span class="go">    raise ValueError(&quot;test exception&quot;)</span>
<span class="go">ValueError: test exception</span>
</code></pre></div>

<p>As you can see, even though there was an exception while processing the third job, my spinner still put a "✔" and that's not right.</p>
<p>To fix this, I need to now catch any Exception that is not a GeneratorExit. This allows me to put an "𝘅" at the start of the line for the job that errored and still provide the exception information.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">spinner</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;working...&quot;</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">𝘅</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">✔</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>

<p><img alt="Simple Python Spinner" loading="lazy" src="/static/images/spinner-simple-3.gif" /></p>
<p>That looks much better!</p>
<p>Checkout the full <a href="https://gist.github.com/joshbduncan/a6a01583292cc7564236a3a1898ce173">Simple Spinner</a> script on Github.</p>
<h2>Context Manager</h2>
<p>Building on the simple example, I can easily create a <a href="https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager">context manager</a> that generates a progress spinner while being used.</p>
<p>First, I can pull the generator out as a separate function...</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">spinner_indicator</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tick</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)]</span>
        <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<p>Then, I can and handle all of the setup, exception catching, and tear down inside of the context manager and only call the generator when I need it.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">spinner</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;working...&quot;</span><span class="p">):</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">spinner_indicator</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">✔</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">𝘅</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">✔</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>

<p>This version allows me to do something like below.</p>
<div class="codehilite"><pre><span></span><code><span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample job&quot;</span><span class="p">,</span> <span class="s2">&quot;another job&quot;</span><span class="p">,</span> <span class="s2">&quot;job with an exception&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">spinner</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_running_iteration</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>

<p>Not necessarily any better than the simple option, just a different solution.</p>
<p><img alt="Spinner Context Manager" loading="lazy" src="/static/images/spinner-ctx-manager.gif" /></p>
<p>Checkout the full <a href="https://gist.github.com/joshbduncan/d47726aa351e467d849748e3de607943">Spinner Context Manager </a> script on Github.</p>
<h2>Over The Top</h2>
<p>Now, to get extra fancy, I'm going combine what I did above into a Python <a href="https://docs.python.org/3/tutorial/classes.html">Class</a>. The Spinner class will allow me to choose different spinners and also allow me to update the progress message while running.</p>
<h3>Spinners Galore</h3>
<p>There are tons of spinners you can come up with but here are the four I'm going to have available for use.</p>
<div class="codehilite"><pre><span></span><code><span class="n">spinners</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;◢&quot;</span><span class="p">,</span> <span class="s2">&quot;◣&quot;</span><span class="p">,</span> <span class="s2">&quot;◤&quot;</span><span class="p">,</span> <span class="s2">&quot;◥&quot;</span><span class="p">],</span>
    <span class="s2">&quot;circle&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;◜&quot;</span><span class="p">,</span> <span class="s2">&quot;◠&quot;</span><span class="p">,</span> <span class="s2">&quot;◝&quot;</span><span class="p">,</span> <span class="s2">&quot;◞&quot;</span><span class="p">,</span> <span class="s2">&quot;◡&quot;</span><span class="p">,</span> <span class="s2">&quot;◟&quot;</span><span class="p">],</span>
    <span class="s2">&quot;dots&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;⠋&quot;</span><span class="p">,</span> <span class="s2">&quot;⠙&quot;</span><span class="p">,</span> <span class="s2">&quot;⠹&quot;</span><span class="p">,</span> <span class="s2">&quot;⠸&quot;</span><span class="p">,</span> <span class="s2">&quot;⠼&quot;</span><span class="p">,</span> <span class="s2">&quot;⠴&quot;</span><span class="p">,</span> <span class="s2">&quot;⠦&quot;</span><span class="p">,</span> <span class="s2">&quot;⠧&quot;</span><span class="p">,</span> <span class="s2">&quot;⠇&quot;</span><span class="p">,</span> <span class="s2">&quot;⠏&quot;</span><span class="p">],</span>
    <span class="s2">&quot;ticks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div>

<h3>Class Structure</h3>
<p>I have setup the Spinner class so that it can be used both as a standard generator or a context manager.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Spinner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;ticks&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Processing...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spinner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_generator</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">𝘅</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">✔</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spinner</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">frame_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">spinners</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">frames</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spinner</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">𝘅</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">✔</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spinner</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>

<div class="callout">
<p>You'll notice a few special dunder methods above, like <code>__enter__</code> and <code>__exit__</code>. These allow the Spinner class to be used as a <a href="https://docs.python.org/3/reference/datamodel.html#with-statement-context-managers">context manager</a>.</p>
</div>
<h4>Using Spinner As A Simple Generator</h4>
<p>The most basic usage of the Spinner class is to create an instance of it and then update it each iteration. You can specify the spinner style and the spinner text.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dots spinner&quot;</span><span class="p">,</span> <span class="s2">&quot;spinner with exception&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;exception&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Spinner</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;exception&quot;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test exception&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p><img alt="Python Spinner Class" loading="lazy" src="/static/images/spinner-object-3.gif" /></p>
<p>You could even update the text at a special place in your job progress.</p>
<div class="codehilite"><pre><span></span><code><span class="o">...</span>
<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">steps</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;half way through&quot;</span><span class="p">)</span>
<span class="o">...</span>
</code></pre></div>

<h4>Using Spinner As A Context Manager</h4>
<p>The Spinner class can also be implemented as a context manager using the standard <code>with</code> syntax.</p>
<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="n">Spinner</span><span class="p">()</span> <span class="k">as</span> <span class="n">spinner</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_running_iteration</span><span class="p">:</span>
        <span class="n">spinner</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</code></pre></div>

<p><img alt="Python Spinner Class" loading="lazy" src="/static/images/spinner-object-1.gif" /></p>
<p>And, just as above, you can update the spinner text as you go...</p>
<div class="codehilite"><pre><span></span><code><span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;angles spinner&quot;</span><span class="p">,</span> <span class="s2">&quot;circle spinner&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">Spinner</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span> <span class="k">as</span> <span class="n">spinner</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_running_iteration</span><span class="p">:</span>
            <span class="n">spinner</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> (step </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">long_running_iteration</span><span class="p">)</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="Python Spinner Class" loading="lazy" src="/static/images/spinner-object-2.gif" /></p>
<p>Checkout the <a href="https://gist.github.com/joshbduncan/0df382217b6ab761f106e45479708b6c">full script</a> on Github.</p>
<h2>Final Thoughts</h2>
<p>There are much better solutions to this problem like <a href="https://github.com/tqdm/tqdm">tqdm</a>, but since I'm still learning, I like to try and figure out how to do things myself. I definitely learn something each time I do.</p>
<p>Cheers 🍻</p>
    </div>
  </section>
  <div id="post-categorization">
    
    <p>
      <b>Category: </b><a href="/category/development.html">development</a>
    </p>
    
    
    <p>
      <b>Tags:</b>
      
      <a href="/tag/cli.html">cli</a>, 
      
      <a href="/tag/generators.html">generators</a>, 
      
      <a href="/tag/python.html">python</a>
      
    </p>
    
  </div>
</article>
<script>
  // add copy code buttons to all `.codehilite` divs
  document.addEventListener("DOMContentLoaded", function () {
    const blocks = document.querySelectorAll(".codehilite");
    const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
    </svg>`
    const copiedIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
      <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
      <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
    </svg>`

    blocks.forEach((block) => {
      const wrapper = document.createElement("div");
      wrapper.classList.add("copy-button")
      wrapper.insertAdjacentHTML("beforeend", copyIcon);
      block.append(wrapper)

      wrapper.addEventListener("click", () => {
        const range = document.createRange();
        range.selectNodeContents(block);
        navigator.clipboard.writeText(block.textContent);
        wrapper.innerHTML = copiedIcon
        wrapper.classList.add("success")
        setTimeout(() => {
          wrapper.innerHTML = copyIcon
          wrapper.classList.remove("success")
        }, 2000);
      });
    })
  })
</script>

  </main>

  <footer>
    <copyright id="copyright">&copy; 2024 Josh Duncan</copyright>
  </footer>

</body>

</html>